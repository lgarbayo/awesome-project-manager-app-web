<section class="stack-md">
  <!-- project form -->
  @if (project(); as projectDetail) {
    <div class="detail-grid">
      <article class="card pad stack-md project-summary-card hero-surface">
        <div class="row row-refresh">
          <div>
            <h2 class="title">{{ projectDetail.title }}</h2>
          </div>
        </div>
        <p class="muted">{{ projectDetail.description || 'No description available yet.' }}</p>
        <div class="summary-grid">
          <div>
            <p class="summary-label">Start date</p>
            <p class="summary-value">{{ core.formatDateLabel(projectDetail.startDate) }}</p>
          </div>
          <div>
            <p class="summary-label">End date</p>
            <p class="summary-value">{{ core.formatDateLabel(projectDetail.endDate) }}</p>
          </div>
        </div>
        <div class="row project-actions-row">
          <button
            class="btn ghost icon-only action-icon"
            type="button"
            (click)="openAnalysisModal()"
            aria-label="View project analysis"
          >
            <img src="/analysis.svg" alt="" width="20" height="20" aria-hidden="true" />
          </button>
          <button class="btn ghost icon-only" type="button" (click)="openProjectModal()">
            <img src="/edit.svg" alt="Edit project" width="20" height="20" />
          </button>
        </div>
      </article>
      <!-- milestones table-->
      <article class="card pad stack-md table-card">
        <div class="row row-refresh">
          <h2 class="title">Milestones</h2>
          <button class="btn primary icon-only" type="button" (click)="openMilestoneModal()">
            <img src="/add.svg" alt="Add milestone" width="24" height="24" />
          </button>
        </div>
        @if (milestoneLoading()) {
          <p>Loading milestones...</p>
        }
        @if (milestoneError(); as error) {
          <p class="error">{{ error }}</p>
        }
        @if (!milestoneLoading() && milestones().length === 0) {
          <p>No milestones registered yet.</p>
        } @else {
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (milestone of milestones(); track trackMilestone($index, milestone)) {
                  <tr>
                    <td>{{ milestone.title }}</td>
                    <td>{{ core.formatDateLabel(milestone.date) }}</td>
                    <td class="table-actions">
                      <button
                        class="btn ghost icon-only"
                        type="button"
                        (click)="openMilestoneDescription(milestone)"
                        aria-label="View milestone description"
                      >
                        <img src="/eye.svg" alt="" width="20" height="20" />
                      </button>
                      <button
                        class="btn ghost icon-only action-icon"
                        type="button"
                        (click)="openMilestoneAnalysis(milestone.uuid)"
                        aria-label="View milestone analysis"
                      >
                        <img src="/analysis.svg" alt="" width="20" height="20" aria-hidden="true" />
                      </button>
                      <button class="btn ghost icon-only" type="button" (click)="editMilestone(milestone)">
                        <img src="/edit.svg" alt="Edit milestone" width="20" height="20" />
                      </button>
                      <button class="btn danger icon-only" type="button" (click)="removeMilestone(milestone.uuid)">
                        <img src="/trash.svg" alt="Delete milestone" width="20" height="20" />
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </article>
    </div>

    <app-task-gantt
      [tasks]="tasks()"
      [milestones]="milestones()"
      [analysis]="analysis()"
      [loading]="taskLoading()"
      [error]="taskError()"
      (addTask)="openTaskModal()"
      (describeTask)="openTaskDescription($event)"
      (analyseTask)="openTaskAnalysis($event)"
      (aiDescribeTask)="describeTaskWithAi($event)"
      (estimateTask)="estimateTask($event)"
      (editTask)="editTask($event)"
      (removeTask)="removeTask($event)"
      (updateTaskTimeline)="onTaskTimelineChange($event)"
    ></app-task-gantt>

    @if (showProjectModal()) {
      <div class="modal-backdrop" (click)="closeProjectModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">Edit project</h2>
            <button class="btn ghost" type="button" (click)="closeProjectModal()">Close</button>
          </div>
          <div class="modal-body">
            <app-project-form
              [data]="projectDetail"
              (edited)="update($event)"
              (cancelled)="closeProjectModal()"
            ></app-project-form>
          </div>
        </div>
      </div>
    }

    @if (showMilestoneModal()) {
      <div class="modal-backdrop" (click)="cancelMilestoneEdition()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ selectedMilestone() ? 'Edit milestone' : 'New milestone' }}</h2>
            <button class="btn ghost" type="button" (click)="cancelMilestoneEdition()">Close</button>
          </div>
          <div class="modal-body">
            <app-milestone-form
              #milestoneCreator
              [data]="selectedMilestone() ?? undefined"
              (submitted)="saveMilestone($event)"
              (cancelled)="cancelMilestoneEdition()"
            ></app-milestone-form>
          </div>
        </div>
      </div>
    }

    @if (showTaskModal()) {
      <div class="modal-backdrop" (click)="cancelTaskEdition()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ selectedTask() ? 'Edit task' : 'New task' }}</h2>
            <button class="btn ghost" type="button" (click)="cancelTaskEdition()">Close</button>
          </div>
          <div class="modal-body">
            <app-task-form
              #taskCreator
              [data]="selectedTask() ?? undefined"
              (submitted)="saveTask($event)"
              (cancelled)="cancelTaskEdition()"
            ></app-task-form>
          </div>
        </div>
      </div>
    }

    @if (showAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeAnalysisModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">Project analysis</h2>
            <button class="btn ghost" type="button" (click)="closeAnalysisModal()">Close</button>
          </div>
          <div class="modal-body">
            @if (analysisLoading()) {
              <p>Loading analysis...</p>
            }
            @if (analysisError(); as error) {
              <p class="error">{{ error }}</p>
            }
            @if (analysis(); as data) {
              <div class="analysis-grid">
                @for (milestoneAnalysis of data.milestoneList; track milestoneAnalysis.milestoneUuid) {
                  <article class="analysis-card">
                    <div class="analysis-card__header">
                      <div>
                        <p class="analysis-card__label">Milestone</p>
                        <h3 class="analysis-card__title">{{ milestoneAnalysis.milestoneTitle }}</h3>
                        <p class="analysis-card__dates">
                          {{ core.formatDateLabel(milestoneAnalysis.startDate) }} →
                          {{ core.formatDateLabel(milestoneAnalysis.endDate) }}
                        </p>
                      </div>
                      <div
                        class="analysis-badge"
                        [class.analysis-badge--up]="milestoneAnalysis.endCompletion >= milestoneAnalysis.initialCompletion"
                        [class.analysis-badge--down]="milestoneAnalysis.endCompletion < milestoneAnalysis.initialCompletion"
                      >
                        <span class="analysis-badge__value">{{ milestoneAnalysis.endCompletion * 100 | number:'1.0-0' }}%</span>
                        <span class="analysis-badge__delta">
                          {{ milestoneAnalysis.endCompletion >= milestoneAnalysis.initialCompletion ? '+' : '' }}
                          {{ (milestoneAnalysis.endCompletion - milestoneAnalysis.initialCompletion) * 100 | number:'1.0-0' }}%
                        </span>
                      </div>
                    </div>
                    <div class="analysis-meter" role="img" aria-label="Progress from initial to final">
                      <div class="analysis-meter__initial" [style.width]="(milestoneAnalysis.initialCompletion * 100) + '%'" aria-hidden="true"></div>
                      <div class="analysis-meter__final" [style.width]="(milestoneAnalysis.endCompletion * 100) + '%'" aria-hidden="true"></div>
                    </div>
                    <ul class="analysis-task-list" aria-label="Task breakdown">
                      @for (taskAnalysis of milestoneAnalysis.taskList; track taskAnalysis.taskUuid) {
                        <li class="analysis-task-list__item">
                          <span class="analysis-task-list__title">{{ taskAnalysis.taskTitle }}</span>
                          <span
                            class="analysis-task-list__delta"
                            [class.positive]="taskAnalysis.endCompletion >= taskAnalysis.initialCompletion"
                            [class.negative]="taskAnalysis.endCompletion < taskAnalysis.initialCompletion"
                          >
                            {{ taskAnalysis.initialCompletion * 100 | number:'1.0-0' }}% →
                            {{ taskAnalysis.endCompletion * 100 | number:'1.0-0' }}%
                          </span>
                        </li>
                      }
                    </ul>
                  </article>
                }
              </div>
            } @else if (!analysisLoading()) {
              <p>No analysis data yet.</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showMilestoneAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeMilestoneAnalysisModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">Milestone analysis</h2>
            <button class="btn ghost" type="button" (click)="closeMilestoneAnalysisModal()">Close</button>
          </div>
          <div class="modal-body">
            @if (milestoneAnalysisMessage(); as message) {
              <p class="muted">{{ message }}</p>
            } @else if (selectedMilestoneAnalysis(); as milestoneAnalysis) {
              <article class="analysis-card analysis-card--modal">
                <div class="analysis-card__header">
                  <div>
                    <p class="analysis-card__label">Milestone</p>
                    <h3 class="analysis-card__title">{{ milestoneAnalysis.milestoneTitle }}</h3>
                    <p class="analysis-card__dates">
                      {{ core.formatDateLabel(milestoneAnalysis.startDate) }} →
                      {{ core.formatDateLabel(milestoneAnalysis.endDate) }}
                    </p>
                  </div>
                  <div
                    class="analysis-badge"
                    [class.analysis-badge--up]="milestoneAnalysis.endCompletion >= milestoneAnalysis.initialCompletion"
                    [class.analysis-badge--down]="milestoneAnalysis.endCompletion < milestoneAnalysis.initialCompletion"
                  >
                    <span class="analysis-badge__value">{{ milestoneAnalysis.endCompletion * 100 | number:'1.0-0' }}%</span>
                    <span class="analysis-badge__delta">
                      {{ milestoneAnalysis.endCompletion >= milestoneAnalysis.initialCompletion ? '+' : '' }}
                      {{ (milestoneAnalysis.endCompletion - milestoneAnalysis.initialCompletion) * 100 | number:'1.0-0' }}%
                    </span>
                  </div>
                </div>
                <div class="analysis-meter" role="img" aria-label="Progress from initial to final">
                  <div class="analysis-meter__initial" [style.width]="(milestoneAnalysis.initialCompletion * 100) + '%'" aria-hidden="true"></div>
                  <div class="analysis-meter__final" [style.width]="(milestoneAnalysis.endCompletion * 100) + '%'" aria-hidden="true"></div>
                </div>
                @if (milestoneAnalysis.taskList.length === 0) {
                  <p class="muted">No task analysis available.</p>
                } @else {
                  <ul class="analysis-task-list" aria-label="Task breakdown">
                    @for (taskAnalysis of milestoneAnalysis.taskList; track taskAnalysis.taskUuid) {
                      <li class="analysis-task-list__item">
                        <span class="analysis-task-list__title">{{ taskAnalysis.taskTitle }}</span>
                        <span
                          class="analysis-task-list__delta"
                          [class.positive]="taskAnalysis.endCompletion >= taskAnalysis.initialCompletion"
                          [class.negative]="taskAnalysis.endCompletion < taskAnalysis.initialCompletion"
                        >
                          {{ taskAnalysis.initialCompletion * 100 | number:'1.0-0' }}% →
                          {{ taskAnalysis.endCompletion * 100 | number:'1.0-0' }}%
                        </span>
                      </li>
                    }
                  </ul>
                }
              </article>
            } @else {
              <p class="muted">No milestone analysis data available yet.</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showTaskAnalysisModal()) {
      <div class="modal-backdrop" (click)="closeTaskAnalysisModal()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">Task analysis</h2>
            <button class="btn ghost" type="button" (click)="closeTaskAnalysisModal()">Close</button>
          </div>
          <div class="modal-body">
            @if (taskAnalysisMessage(); as message) {
              <p class="muted">{{ message }}</p>
            } @else if (selectedTaskAnalysis(); as taskAnalysis) {
              <article class="analysis-card analysis-card--modal">
                <div class="analysis-card__header">
                  <div>
                    <p class="analysis-card__label">Task</p>
                    <h3 class="analysis-card__title">{{ taskAnalysis.taskTitle }}</h3>
                    <p class="analysis-card__dates">Completion trend</p>
                  </div>
                  <div
                    class="analysis-badge"
                    [class.analysis-badge--up]="taskAnalysis.endCompletion >= taskAnalysis.initialCompletion"
                    [class.analysis-badge--down]="taskAnalysis.endCompletion < taskAnalysis.initialCompletion"
                  >
                    <span class="analysis-badge__value">{{ taskAnalysis.endCompletion * 100 | number:'1.0-0' }}%</span>
                    <span class="analysis-badge__delta">
                      {{ taskAnalysis.endCompletion >= taskAnalysis.initialCompletion ? '+' : '' }}
                      {{ (taskAnalysis.endCompletion - taskAnalysis.initialCompletion) * 100 | number:'1.0-0' }}%
                    </span>
                  </div>
                </div>
                <div class="analysis-meter" role="img" aria-label="Progress from initial to final">
                  <div class="analysis-meter__initial" [style.width]="(taskAnalysis.initialCompletion * 100) + '%'" aria-hidden="true"></div>
                  <div class="analysis-meter__final" [style.width]="(taskAnalysis.endCompletion * 100) + '%'" aria-hidden="true"></div>
                </div>
              </article>
            } @else {
              <p class="muted">No task analysis data available yet.</p>
            }
          </div>
        </div>
      </div>
    }

    @if (showMilestoneDescriptionModal() && selectedMilestoneDescription(); as milestoneDescription) {
      <div class="modal-backdrop" (click)="closeMilestoneDescription()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ milestoneDescription.title }} description</h2>
            <button class="btn ghost" type="button" (click)="closeMilestoneDescription()">Close</button>
          </div>
          <div class="modal-body">
            <p>{{ milestoneDescription.description || 'No description.' }}</p>
          </div>
        </div>
      </div>
    }

    @if (showTaskDescriptionModal() && selectedTaskDescription(); as taskDescription) {
      <div class="modal-backdrop" (click)="closeTaskDescription()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ taskDescription.title }} description</h2>
            <button class="btn ghost" type="button" (click)="closeTaskDescription()">Close</button>
          </div>
          <div class="modal-body">
            <p>{{ taskDescription.description || 'No description.' }}</p>
          </div>
        </div>
      </div>
    }

    @if (showTaskEstimateModal() && selectedTaskEstimate(); as taskEstimateTarget) {
      <div class="modal-backdrop" (click)="closeTaskEstimate()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ taskEstimateTarget.title }} estimate</h2>
            <button class="btn ghost" type="button" (click)="closeTaskEstimate()">Close</button>
          </div>
          <div class="modal-body stack-md">
            <p class="muted">Each run can change a bit, feel free to ask for a new estimate.</p>
            @if (taskEstimateLoading()) {
              <p>Requesting estimate...</p>
            }
            @if (taskEstimateError(); as estimateError) {
              <p class="error">{{ estimateError }}</p>
            }
            @if (taskEstimate(); as estimateResult) {
              <div class="stack-sm">
                <p class="summary-label">Estimated hours</p>
                <p class="summary-value">{{ estimateResult.hours }}</p>
                <p>{{ estimateResult.explanation }}</p>
              </div>
            } @else if (!taskEstimateLoading() && !taskEstimateError()) {
              <p class="muted">Waiting for the estimate.</p>
            }
            <div class="row">
              <button class="btn primary" type="button" (click)="retryTaskEstimate()" [disabled]="taskEstimateLoading()">
                Request new estimate
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    @if (showTaskSuggestionModal() && selectedTaskSuggestion(); as taskSuggestionTarget) {
      <div class="modal-backdrop" (click)="closeTaskSuggestion()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2 class="title">{{ taskSuggestionTarget.title }} AI description</h2>
            <button class="btn ghost" type="button" (click)="closeTaskSuggestion()">Close</button>
          </div>
          <div class="modal-body stack-md">
            <p class="muted">Ask the assistant for a new description. You can tweak the prompt below.</p>
            <label class="summary-label" for="aiPrompt">Prompt (optional)</label>
            <textarea
              id="aiPrompt"
              rows="3"
              [value]="taskSuggestionPrompt()"
              (input)="taskSuggestionPrompt.set($any($event.target).value)"
            ></textarea>
            <div class="row">
              <button class="btn primary" type="button" (click)="retryTaskSuggestion()" [disabled]="taskSuggestionLoading()">
                Generate description
              </button>
            </div>
            @if (taskSuggestionLoading()) {
              <p>Requesting description...</p>
            }
            @if (taskSuggestionError(); as suggestionError) {
              <p class="error">{{ suggestionError }}</p>
            }
            @if (taskSuggestion(); as suggestion) {
              <div class="stack-sm">
                <p class="summary-label">Suggested title</p>
                <p class="summary-value">{{ suggestion.title }}</p>
                <p class="summary-label">Suggested description</p>
                <p>{{ suggestion.description }}</p>
                @if (suggestion.rawAnswer) {
                  <details>
                    <summary>Raw answer</summary>
                    <p class="muted">{{ suggestion.rawAnswer }}</p>
                  </details>
                }
              </div>
            } @else if (!taskSuggestionLoading() && !taskSuggestionError()) {
              <p class="muted">No suggestion yet. Try generating one.</p>
            }
          </div>
        </div>
      </div>
    }
  } @else {
    <article class="card pad">
      <p>Select a project from the list to keep working.</p>
    </article>
  }
</section>
